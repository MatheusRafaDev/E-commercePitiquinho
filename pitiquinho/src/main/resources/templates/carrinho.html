<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitiquinho | Carrinho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/carrinho.css">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-4">
    <h2 class="mb-4">ðŸ›’ Carrinho de Compras</h2>

    <div class="card mb-4">
        <div class="card-body">
            <table class="table">
                <thead>
                <tr>
                    <th>Produto</th>
                    <th>Quantidade</th>
                    <th>PreÃ§o</th>
                    <th>Subtotal</th>
                    <th>AÃ§Ã£o</th>
                </tr>
                </thead>
                <tbody id="carrinho-body">
                <!-- Itens serÃ£o carregados por JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- SeÃ§Ã£o de Entrega -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">ðŸšš Entrega</h5>

            <!-- Se tem endereÃ§o salvo -->
            <div th:if="${usuario != null and enderecoUsuario != null}">
                <div class="alert alert-success">
                    <i class="fas fa-home me-2"></i>
                    <strong>EndereÃ§o cadastrado:</strong><br>
                    <span th:text="${enderecoUsuario.logradouro + ', ' + enderecoUsuario.numero}"></span>
                    <span th:if="${enderecoUsuario.complemento != null and !enderecoUsuario.complemento.isEmpty()}"
                          th:text="', ' + ${enderecoUsuario.complemento}"></span><br>
                    <span th:text="${enderecoUsuario.bairro}"></span><br>
                    <span th:text="${enderecoUsuario.cidade}"></span> -
                    <span th:text="${enderecoUsuario.estado != null ? enderecoUsuario.estado : enderecoUsuario.uf}"></span><br>
                    <span th:text="'CEP: ' + ${enderecoUsuario.cep}"></span>
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="usarOutroCEP()">
                    <i class="fas fa-edit me-1"></i> Usar outro CEP
                </button>
            </div>

            <!-- SeÃ§Ã£o para informar CEP -->
            <div id="cep-section" th:classappend="${usuario == null or enderecoUsuario == null} ? '' : 'd-none'">
                <div class="mb-3">
                    <label for="cep">Informe o CEP:</label>
                    <div class="input-group">
                        <input type="text" id="cep" class="form-control" placeholder="00000-000"
                               th:value="${enderecoUsuario != null ? enderecoUsuario.cep : ''}">
                        <button class="btn btn-primary" onclick="calcularFrete()">
                            <i class="fas fa-truck me-1"></i> Calcular Frete
                        </button>
                    </div>
                </div>

                <!-- OpÃ§Ãµes de frete -->
                <div id="frete-opcoes" class="d-none">
                    <div class="form-group">
                        <label>Escolha o frete:</label>
                        <select id="opcao-frete" class="form-control" onchange="atualizarTotal()">
                            <option value="0">Selecione</option>
                            <option value="10">Normal - R$ 10,00 (3-5 dias)</option>
                            <option value="17">Expresso - R$ 17,00 (1-2 dias)</option>
                            <option value="25">Super Expresso - R$ 25,00 (24h)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumo -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">ðŸ“‹ Resumo do Pedido</h5>

            <div class="row mb-2">
                <div class="col">Subtotal:</div>
                <div class="col text-end"><strong id="subtotal">R$ 0,00</strong></div>
            </div>

            <div class="row mb-2">
                <div class="col">Frete:</div>
                <div class="col text-end"><strong id="valor-frete">R$ 0,00</strong></div>
            </div>

            <hr>

            <div class="row mb-3">
                <div class="col"><h5>Total:</h5></div>
                <div class="col text-end"><h5 id="total-final">R$ 0,00</h5></div>
            </div>

            <!-- BotÃ£o Finalizar -->
            <div th:if="${usuario != null}">
                <form th:action="@{/finalizar/checkout}" method="post" onsubmit="return validarCheckout()">
                    <input type="hidden" id="cep-final" name="cep">
                    <button type="submit" class="btn btn-success btn-lg w-100" id="btn-finalizar" disabled>
                        <i class="fas fa-lock me-2"></i>Finalizar Compra
                    </button>
                </form>
            </div>

            <div th:if="${usuario == null}" class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <a href="/login?redirect=carrinho" class="alert-link">FaÃ§a login</a> para finalizar a compra.
            </div>
        </div>
    </div>

    <!-- BotÃµes extras -->
    <div class="mt-3 d-flex justify-content-between">
        <a href="/produtos" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Continuar Comprando
        </a>
        <button class="btn btn-outline-danger" onclick="limparCarrinho()">
            <i class="fas fa-trash me-2"></i>Limpar Carrinho
        </button>
    </div>
</div>

<script>
    // VariÃ¡veis globais
    let carrinhoItens = JSON.parse(localStorage.getItem('carrinho')) || [];

    // Inicializar carrinho
    function carregarCarrinho() {
        if (carrinhoItens.length === 0) {
            document.getElementById('carrinho-body').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <i class="fas fa-shopping-cart fa-2x text-muted mb-3"></i>
                        <p class="text-muted">Seu carrinho estÃ¡ vazio</p>
                    </td>
                </tr>`;
            return;
        }

        // Aqui vocÃª implementaria a lÃ³gica para mostrar os itens
        // Por enquanto, apenas um exemplo
        document.getElementById('subtotal').textContent = 'R$ 0,00';
    }

    // Calcular frete
    function calcularFrete() {
        const cep = document.getElementById('cep').value.replace(/\D/g, '');

        if (cep.length !== 8) {
            alert('Digite um CEP vÃ¡lido (8 dÃ­gitos)');
            return;
        }

        // Simular busca
        document.getElementById('frete-opcoes').classList.remove('d-none');
        document.getElementById('btn-finalizar').disabled = false;
        document.getElementById('cep-final').value = cep;

        // Atualizar total
        atualizarTotal();
    }

    // Usar outro CEP
    function usarOutroCEP() {
        document.getElementById('cep-section').classList.remove('d-none');
    }

    // Atualizar total
    function atualizarTotal() {
        const frete = parseFloat(document.getElementById('opcao-frete').value) || 0;
        const subtotal = 0; // Substituir pelo valor real do carrinho

        document.getElementById('valor-frete').textContent = `R$ ${frete.toFixed(2).replace('.', ',')}`;
        document.getElementById('total-final').textContent = `R$ ${(subtotal + frete).toFixed(2).replace('.', ',')}`;
    }

    // Validar checkout
    function validarCheckout() {
        const frete = document.getElementById('opcao-frete').value;

        if (frete === "0") {
            alert('Por favor, selecione uma opÃ§Ã£o de frete');
            return false;
        }

        return true;
    }

    // Limpar carrinho
    function limparCarrinho() {
        if (confirm('Tem certeza que deseja limpar o carrinho?')) {
            localStorage.removeItem('carrinho');
            location.reload();
        }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        carregarCarrinho();

        // Se tem endereÃ§o salvo, calcular frete automaticamente
        if (/*[[${usuario != null and enderecoUsuario != null}]]*/ false) {
            calcularFrete();
        }
    });
</script>
</body>
</html>